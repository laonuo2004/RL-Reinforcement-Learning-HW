#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
###########################################################################
# Copyright © 1998 - 2025 Tencent. All Rights Reserved.
###########################################################################
"""
Author: Tencent AI Arena Authors
"""


import time
import os
import numpy as np
import torch
from agent_dqn.conf.conf import Config
from agent_dqn.model.model import Model
from agent_dqn.feature.definition import ActData
from queue import Queue


class Algorithm:
    def __init__(self, device, monitor):
        self.device = device
        self.lr = Config.START_LR
        self.epsilon = Config.EPSILON
        self.egp = Config.EPSILON_GREEDY_PROBABILITY
        self._gamma = Config.GAMMA
        self.obs_split = Config.DESC_OBS_SPLIT
        self.obs_shape = Config.DIM_OF_OBSERVATION
        self.talent_direction = Config.DIM_OF_TALENT
        self.direction_space = Config.DIM_OF_ACTION_DIRECTION
        self.act_shape = Config.DIM_OF_ACTION_DIRECTION + Config.DIM_OF_TALENT

        self.train_step = 0
        self.predict_count = 0
        self.model = Model(
            state_shape=self.obs_shape,
            action_shape=self.act_shape,
            softmax=False,
        )
        self.model.to(self.device)
        self.device = device
        self.monitor = monitor
        self.last_report_monitor_time = 0
        self.optim = torch.optim.Adam(self.model.parameters(), lr=self.lr)

        data ="""
88888888888888888888888888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000001111111111111100000000000000000000000000000000000000000000000000000000
88888800000000000000000000000000000000000000000000000000001111111111111100000000000000000000000000000000000000000000000000000000
88888800000000000000001111111111111111110000000000000000001111111111111111000000000000000000000000000000000000000000000000000000
88888800000000000000001111111111111111110000000000000000001111111111111111000000000000000000000000000000000000000000000000000000
88888800000000000000111111111111111111110000000000000000001111111111111111110000000000000000000000000000000000000000000000000000
88888800000000000000111111111111111111110000000000000000001111111111111111110000000000000000000000000000000000000000000000000000
88888800000000000011111111111111111111110000000000000000001111111111111111111100000000000000000000000000000000000000000000000000
88888800000000000011111111111111111111110000000000000000001111111111111111111100000000000000000000000000000000000000000000000000
88888800000000000011111111111111111111110000000000000000000000000000011111111111000000000000000000000000000000000000000000000000
88888800000000000011111111111111111111110000000000000000000000000000011111111111000000000000000000000000000000000000000000000000
88888800000000001111111111110000000000000000000000000000000000000000000211111111000000000000000000000000000000000000000000000000
88888800000000001111111111110000000000000000000000000000000000000000000111111111000000000000000000000000000000000000000000000000
88888800000000111111111111000000000000000000000000000000000000000000000111111111110000000000000000000000111111110000000000000000
88888800000000111111111111000000000000000000000000000000000000000000000111111111110000000000000000000000111111110000000000000000
88888800000000111111111100000000000000000000000000000000000000000000000002111111111100000000000000000000111111110000000000000000
88888800000000111111111100000000000000000000000000000000000000000000000002221111111100000000000000000000111111110000000000000000
88888800000011111111110000000000000000000000000000000000000000000000000000021111111100000000000000000000111111110000000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000021111111100000000000000000000111111110000000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000111111111000000000000000000111111110000000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000111111111000000000000000000111111110000000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000001111111000000000000000000111111111100000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000001111111000000000000000000111111111100000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000001111111000000000000000000111111111100000000000000
00000000000011111111110000000000000000000000000000000000000000000000000000000001111111000000000000000000111111111100000000000000
00000000000011111111111100000000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000011111111111100000000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000000111111111111000000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000000111111111111000000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000000211111111111110000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000000211111111111110000000000000000000000000000000000000000000000000000111111000000000000000000111111111100000000000000
00000000000000002111111111111100000000000000000000000000000000000000000000000011111111000000000000000000111111111100000000000000
00000000000000002111111111111100000000000000000000000000000000000000000000000011111111000000000000000000111111111100000000000000
00000000000000000021111111111111111111111100000000000000000000000000000011111111111111000000000000000000111111110000000000000000
00000000000000000022111111111111111111111100000000000000000000000000000011111111111111000000000000000000111111110000000000000000
00000000000000000000211111111111111111111111111111000000000000001111111111111111111111110000000000001111111111110000000000000000
00000000000000000000211111111111111111111111111111000000000000001111111111111111111111110000000000001111111111110000000000000000
00000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000
00000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000
00000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000
00000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000
00000000000000000000001111111100000000111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000
00000000000000000000001111111100000000111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000
00000000000000000000221111111100000000000000000011111111111111111111000000000000000000000000000000000000000000000000000000000000
00000000000000000000211111111100000000000000000011111111111111111111000000000000000000000000000000000000000000000000000000000000
00000000000000000000211111110000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000
00000000000000000000111111110000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000000011111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000111111110000000000000000000000
00000000000000001111111111110000000000000000000000000000111111110000000000000000000000000000000000111111110000000000000000000000
00000000000000111111111111110000000000000000000000000011111111110000000000000000000000000000000000111111111100000000000000000000
00000000000000111111111111110000000000000000000000000011111111110000000000000000000000000000000000111111111100000000000000000000
00000000000000111111111111111111111111111111111111111111111111111100000000000000000000000000000000111111111111000000000000000000
00000000000000111111111111111111111111111111111111111111111111111100000000000000000000000000000000111111111111000000000000000000
00000000000011111111111111111111111111111111111111111111111111111111110000000000000000000000000000111111111111000000000000000000
00000000000011111111111111111111111111111111111111111111111111111111110000000000000000000000000000111111111111000000000000000000
00000000001111111111111111111111111111111111111111111111111111111111111100000000000000000000000000111111111111000000000000000000
00000000001111111111111111111111111111111111111111111111111111111111111100000000000000000000000000111111111111000000000000000000
00000000001111111111111111111111111111111111111111111111111111111111111111000000000000000000000000111111111111000000000000000000
00000000001111111111111111111111111111111111111111111111111111111111111111000000000000000000000000111111111111000000000000000000
00000000001111111111111111000000000000000000000000000000111111111111111111110000000000000000000000111111111100000000000000000000
00000000001111111111111111000000000000000000000000000000111111111111111111110000000000000000000000111111111100000000000000000000
00000000001111111111110000000000000000000000000000000000000000111111111111110000000000000000000000111111111100000000000000000000
00000000001111111111110000000000000000000000000000000000000000111111111111110000000000000000000000111111111100000000000000000000
00000000001111111100000000000000000000000000000000000000000000001111111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000001111111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000011111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000011111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000000111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000011111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000011111111110000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000011111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111110000000000000000000011111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111111100000000000000000011111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000111111111100000000000000000011111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000011111111111100000000000000001111111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000011111111111100000000000000001111111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000001111111111111100000000000000001111111111000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000001111111111111100000000000000001111111111000000000000000000000000
00000000001111111100000000000000000000111111111111111111111111111111111111111100000000000000111111111100000000000000000000000000
00000000001111111100000000000000000000111111111111111111111111111111111111111100000000000000111111111100000000000000000000000000
00000000001111111100000000000000000000111111111111111111111111111111111111111111000000000000111111111100000000000000000000000000
00000000001111111100000000000000000000111111111111111111111111111111111111111111000000000000111111111100000000000000000000000000
00000000001111111100000000000000001111111111111111111111111111111111111111111111111100001111111111110000000000000000000000000000
00000000001111111100000000000000001111111111111111111111111111111111111111111111111100001111111111110000000000000000000000000000
00000000001111111100000000000000001111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000
00000000001111111100000000000000001111111111111111111111111122222222222222111111111111111111111111110000000000000000000000000000
00000000001111111100000000000000000011111111111111111111111100000000000000111111111111111111111111000000000000000000000000000000
00000000001111111100000000000000000011111111222222222222222200000000000000111111111111111111111111000000000000000000000000000000
00000000001111111100000000000000000000111111000000000000000000000000000000111111111111111111110000000000000000000000000000000000
00000000001111111100000000000000000000111111000000000000000000000000000000111111111111111111110000000000000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000000000111111111111111111000000000000000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000000000111111111111111111000000000000000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000000000111111111111110000000000000000000000000000000000000000
00000000001111111100000000000000000000000000000000000000000000000000000000111111111111110000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000111111111111110000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000111111111111110000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888
        """
        data = data.strip()
        lines = data.split('\n')
        self.Map = np.full((128, 128), -1)
        for i in range(128) :
            self.Map[127 - i] = np.array([int(char) for char in lines[i]])
        self.treasures = [(53, 59), (105, 109), (13, 15), (11, 77), (55, 103), (113, 35), (45, 73), (19, 41), (117, 59), (81, 59), (53, 33), (31, 101), (97, 15), (83, 107), (73, 21), (41, 13)]
        self.order = [7, 3, 11 ,4, 6, 0, 10, 15, 14, 12, 5, 9, 8, 13, 1]
        self.idx = 0
        self.dir_map = np.zeros((16, 128, 128), dtype=int)
        self.generate_dir()
    
    def generate_map(self, dir, pos) :
        q = Queue()
        q.put(pos)
        vis = np.zeros((128, 128))
        vis[pos] = 1
        def check(x, y) :
            if x < 0 or x >= 128 or y < 0 or y >= 128 : return False
            if vis[x, y] or (self.Map[x, y] != 1 and self.Map[x, y] != 2) : return False
            vis[x, y] = 1
            return True
        while not q.empty() :
            x, y = q.get()
            if self.Map[x, y] == 2 : continue
            if check(x - 1, y):
                q.put((x - 1, y))
                dir[x - 1, y] = 2
            if check(x + 1, y): 
                q.put((x + 1, y))
                dir[x + 1, y] = 6
            if check(x, y - 1):
                q.put((x, y - 1))
                dir[x, y - 1] = 0
            if check(x, y + 1):
                q.put((x, y + 1))
                dir[x, y + 1] = 4
            if self.Map[x - 1, y] == 0 or self.Map[x + 1, y] == 0 or self.Map[x, y - 1] == 0 or self.Map[x, y + 1] == 0 : continue
            if check(x - 1, y - 1) :
                q.put((x - 1, y - 1))
                dir[x - 1, y - 1] = 1
            if check(x - 1, y + 1) :
                q.put((x - 1, y + 1))
                dir[x - 1, y + 1] = 3
            if check(x + 1, y + 1) :
                q.put((x + 1, y + 1))
                dir[x + 1, y + 1] = 5
            if check(x + 1, y - 1) :
                q.put((x + 1, y - 1))
                dir[x + 1, y - 1] = 7
        return dir
    def generate_dir(self) :
        for i in range(16) :
            self.dir_map[i] = self.generate_map(self.dir_map[i], self.treasures[i])

    def exploit_Map(self, list_obs_data) :
        assert len(list_obs_data) == 1
        obj = list_obs_data[0]
        if obj.gridpos == (13, 15) :
            self.idx = 0
            Act = ActData(move_dir=0, use_talent=1)
            return [Act]
        
        x, y = obj.gridpos
        tx, ty = self.treasures[self.order[self.idx]]
        if (x, y) == (tx, ty) or (x + 1, y) == (tx, ty) or (x - 1, y) == (tx, ty) or (x, y + 1) == (tx, ty) or (x, y - 1) == (tx, ty) :
            self.idx += 1
        if self.idx >= len(self.order): self.idx = len(self.order) - 1
        # print(f"pos = {obj.gridpos}, idx = {self.idx}, id = {self.order[self.idx]}, dir = {self.dir_map[self.order[self.idx]][x][y]}")
        Act = ActData(move_dir=self.dir_map[self.order[self.idx]][x][y], use_talent=0)
        return [Act]

    def update_Map_information(self, pos, lst) :
        # print(id(self.Map))
        array = np.array(lst)
        array = array.reshape(51, 51)
        x, y = pos.z, pos.x
        for i in range(51) :
            for j in range(51) :
                tx, ty = x - 25 + i, y - 25 + j
                if tx < 0 or tx >= 128 or ty < 0 or ty >= 128: continue
                # assert self.Map[tx][ty] == -1 or array[i][j] != -1
                self.Map[tx][ty] = array[i][j]

    def learn(self, list_sample_data):
        # print("Learning!!!!")
        # self.generate_dir()
        t_data = list_sample_data
        batch = len(t_data)

        batch_feature_vec = [frame.obs[: self.obs_split[0]] for frame in t_data]
        batch_feature_map = [frame.obs[self.obs_split[0] :] for frame in t_data]
        batch_action = torch.LongTensor(np.array([int(frame.act) for frame in t_data])).view(-1, 1).to(self.device)

        _batch_obs_legal = torch.stack([frame._obs_legal for frame in t_data])
        _batch_obs_legal = (
            torch.cat(
                (
                    _batch_obs_legal[:, 0].unsqueeze(1).expand(batch, self.direction_space),
                    _batch_obs_legal[:, 1].unsqueeze(1).expand(batch, self.talent_direction),
                ),
                1,
            )
            .bool()
            .to(self.device)
        )

        rew = torch.tensor(np.array([frame.rew for frame in t_data]), device=self.device)
        _batch_feature_vec = [frame._obs[: self.obs_split[0]] for frame in t_data]
        _batch_feature_map = [frame._obs[self.obs_split[0] :] for frame in t_data]
        not_done = torch.tensor(np.array([0 if frame.done == 1 else 1 for frame in t_data]), device=self.device)

        batch_feature = [
            self.__convert_to_tensor(batch_feature_vec),
            self.__convert_to_tensor(batch_feature_map).view(batch, *self.obs_split[1]),
        ]
        _batch_feature = [
            self.__convert_to_tensor(_batch_feature_vec),
            self.__convert_to_tensor(_batch_feature_map).view(batch, *self.obs_split[1]),
        ]

        model = getattr(self, "model")
        model.eval()
        with torch.no_grad():
            q, h = model(_batch_feature, state=None)
            q = q.masked_fill(~_batch_obs_legal, float(torch.min(q)))
            q_max = q.max(dim=1).values.detach()

        target_q = rew + self._gamma * q_max * not_done

        self.optim.zero_grad()

        model = getattr(self, "model")
        model.train()
        logits, h = model(batch_feature, state=None)

        loss = torch.square(target_q - logits.gather(1, batch_action).view(-1)).mean()
        loss.backward()

        model_grad_norm = torch.nn.utils.clip_grad_norm_(model.parameters(), 1.0)
        self.optim.step()

        self.train_step += 1

        value_loss = loss.detach().item()
        q_value = target_q.mean().detach().item()
        reward = rew.mean().detach().item()

        # Periodically report monitoring
        # 按照间隔上报监控
        now = time.time()
        if now - self.last_report_monitor_time >= 60:
            monitor_data = {
                "value_loss": value_loss,
                "q_value": q_value,
                "reward": reward,
                "diy_1": model_grad_norm,
            }
            if self.monitor:
                self.monitor.put_data({os.getpid(): monitor_data})

            self.last_report_monitor_time = now

    def __convert_to_tensor(self, data):
        if isinstance(data, list):
            data = [np.array(item, dtype=np.float32) for item in data]
        elif isinstance(data, np.ndarray):
            if data.dtype == np.object:
                data = data.astype(np.float32)
            else:
                data = data.astype(np.float32)
        else:
            raise TypeError(f"Unsupported data type: {type(data)}")

        tensor = torch.stack([torch.tensor(item) for item in data]).to(self.device)
        return tensor

    def predict_detail(self, list_obs_data, exploit_flag=False):
        batch = len(list_obs_data)
        feature_vec = [obs_data.feature[: self.obs_split[0]] for obs_data in list_obs_data]
        feature_map = [obs_data.feature[self.obs_split[0] :] for obs_data in list_obs_data]
        legal_act = [obs_data.legal_act for obs_data in list_obs_data]
        legal_act = torch.tensor(np.array(legal_act))
        legal_act = (
            torch.cat(
                (
                    legal_act[:, 0].unsqueeze(1).expand(batch, self.direction_space),
                    legal_act[:, 1].unsqueeze(1).expand(batch, self.talent_direction),
                ),
                1,
            )
            .bool()
            .to(self.device)
        )
        model = self.model
        model.eval()
        # Exploration factor,
        # we want epsilon to decrease as the number of prediction steps increases, until it reaches 0.1
        # 探索因子, 我们希望epsilon随着预测步数越来越小，直到0.1为止
        self.epsilon = max(0.1, self.epsilon - self.predict_count / self.egp)

        with torch.no_grad():
            # epsilon greedy
            if not exploit_flag and np.random.rand(1) < self.epsilon:
                random_action = np.random.rand(batch, self.act_shape)
                random_action = torch.tensor(random_action, dtype=torch.float32).to(self.device)
                random_action = random_action.masked_fill(~legal_act, 0)
                act = random_action.argmax(dim=1).cpu().view(-1, 1).tolist()
            else:
                feature = [
                    self.__convert_to_tensor(feature_vec),
                    self.__convert_to_tensor(feature_map).view(batch, *self.obs_split[1]),
                ]
                logits, _ = model(feature, state=None)
                logits = logits.masked_fill(~legal_act, float(torch.min(logits)))
                act = logits.argmax(dim=1).cpu().view(-1, 1).tolist()

        format_action = [[instance[0] % self.direction_space, instance[0] // self.direction_space] for instance in act]
        self.predict_count += 1
        # ret = [ActData(move_dir=i[0], use_talent=i[1]) for i in format_action]
        # print(f"\n\n\n\n\n{format_action}\n\n\n\n")
        # exit(0)
        return [ActData(move_dir=i[0], use_talent=i[1]) for i in format_action]
